WITH active_users AS (
    SELECT
        country,
        COUNT(*) FILTER (WHERE CAST(last_active_date AS DATE) >= '2024-01-31'::DATE - INTERVAL '30 days'
                         AND monthly_active_sessions >= 5
                         AND listening_hours >= 10) AS active_users_count,
        COUNT(*) AS total_users,
        total_population 
    FROM
        penetration_analysis
    GROUP BY
        country,
        total_population
), penetration_rate AS (
    SELECT
        country,
        -- Ensure division by at least 1 to avoid division by zero
        -- Convert the result to FLOAT for accurate division
        active_users_count::FLOAT / GREATEST(total_population, 1) AS active_user_penetration_rate
    FROM
        active_users
)
SELECT
    country,
    -- Format the penetration rate with 10 decimal places. Adjust the format as needed.
    TO_CHAR(active_user_penetration_rate, 'FM0.0000000000') AS active_user_penetration_rate
FROM
    penetration_rate;